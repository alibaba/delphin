apiVersion: "tuning.kubedl.io/v1alpha1"
kind: ProfilingExperiment
metadata:
  namespace: morphling-system
  name: mobilenet-experiment-random-3
spec:
  objective:
    type: maximize
    objectiveMetricName: qps
  algorithm:
    algorithmName: grid
  parallelism: 1
  maxNumTrials: 18
  clientTemplate:
    metadata:
      name: "mobilenet-client"
      namespace: "default"
    spec:
      template:
        spec:
          containers:
          - name: pi
            image: kubedl/morphling-http-client
            env:
              - name: TF_CPP_MIN_LOG_LEVEL
                value: "3"
              - name: MODEL_NAME
                value: "mobilenet"
            resources:
              requests:
                cpu: 800m
                memory: "1800Mi"
              limits:
                cpu: 800m
                memory: "1800Mi"
            command: [ "python3" ]
            args: ["morphling_client.py", "--model", "mobilenet", "--printLog", "True", "--num_tests", "30"]

            imagePullPolicy: IfNotPresent
          restartPolicy: Never
      backoffLimit: 1

  servicePodTemplate:
    metadata:
      name: "resnet-pod"
      namespace: "default"
    template:
      spec:
        containers:
          - name: resnet-container
            image: kubedl/morphling-tf-model:demo-cv #registry.cn-hangzhou.aliyuncs.com/delphin/resnet-model:aws #kubedl/morphling-tf-model:mobilenet #gcr.io/tensorflow-serving/resnet
            imagePullPolicy: IfNotPresent
            env:
              - name: MODEL_NAME
                value: "mobilenet"
            resources:
              requests:
                cpu: 1
                memory: "1800Mi"
                # nvidia.com/gpu: "1"
              limits:
                cpu: 1
                memory: "1800Mi"
                # nvidia.com/gpu: "1"
            ports:
              - containerPort: 8500

  tunableParameters:
    - category: "resource"
      parameters:
        - parameterType: discrete
          name: "cpu"
          feasibleSpace:
            list:
              - "500m"
              - "1500m"
              - "2000m"
        - parameterType: discrete
          name: "memory"
          feasibleSpace:
            list:
              - "500Mi"
              - "1000Mi"
              - "2000Mi"
#            min: "1"
#            max: "2"
#            step: "0.1"
    - category: "env"
      parameters:
#        - parameterType: double
#          name: "GPU_MEM"
#          feasibleSpace:
#            min: "0.20"
#            max: "1.01"
#            step: "0.20"
        - parameterType: discrete
          name: "BATCH_SIZE"
          feasibleSpace:
            list:
              - "1"
              - "2"
              # - "2"
              # - "4"
              # - "8"
              # - "16"
              # - "32"
              # - "64"
              # - "128"
